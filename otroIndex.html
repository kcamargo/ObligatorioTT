<!DOCTYPE html>
<html>
<head>
  <title>Proyecto Otro</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.1/jquery.mobile-1.2.1.min.css" />
  <script src="http://code.jquery.com/jquery-1.8.3.min.js"></script>
  <script>
  $(document).bind('mobileinit',function(){
    $.mobile.pushStateEnabled = false;
  });

  </script>
  <script src="http://code.jquery.com/mobile/1.2.1/jquery.mobile-1.2.1.min.js"></script>
</head>
<body>
  <!-- Expenses -->
  <script type="text/javascript">

  /*
  * GET:
  * URL: http://finanzapersonal.tribus.com.uy/login?user=kari&password=1234
  * Headers: Metadata que manda el navegador
  *   Soy un chrome
  *   Acepto que me devuelvas json
  */

  /*
  * POST:
  * URL: http://finanzapersonal.tribus.com.uy/register
  * Headers: Metadata que manda el navegador
  *   Soy un chrome
  *   Acepto que me devuelvas json
  * Body:
  *   userT=kari&passwordT=1234
  */

    var db = window.openDatabase('BdFinzanzas', '1.0', 'Test DB', 2 * 1024 * 1024);
    var isLogged = false;

    $(document).ready(function() {
      initializeDB();
      // createBdAccount();
      loadExpensesCategories();
      loadIncomeCategories();

      /*
      * Set Up
      */
      $("#register-button").bind("tap", function () {
        $.mobile.loading("show");
        var user =  $("#userA").val();
        var password = $('#passwordA').val();
        var onSuccess = function (data) {
          debugger;
          $.mobile.loading("hide");
          $.mobile.changePage( "#firstEntry", { transition: "slideup"} );
          isLogged = data.resultado_operacion === "OK";
        };
        register(user, password, onSuccess);
      });

      $("#login-button").bind("tap", function () {
        $.mobile.loading("show");
        var user =  $("#userLogin").val();
        var password = $('#passwordLogin').val();
        var onSuccess = function (data) {
          $.mobile.loading("hide");
          isLogged = data.resultado_operacion === "OK" && data.resultado_login;
          if (isLogged) {
            $.mobile.changePage( "#home", { transition: "slideup"} );
          } else {
            // TODO: Implementar
          }
        };
        login(user, password, onSuccess);
      });

      $("#add-account-save").bind("tap", function () {
        $.mobile.loading("show");
        var name = $("#add-account-name").val();
        var currency = $('#add-account-currency').val();
        var balance = Number($("#add-account-balance").val());
        var onSuccess = function (tx, result) {
          var onEntrySuccess = function (tx, data) {
            $.mobile.loading("hide");
            $.mobile.changePage( "#list-accounts", { transition: "slideup"} );
          };
          addEntry(result.insertId, new Date(), "Balance Inicial", balance, onEntrySuccess);
        };
        addAccount(name, currency, balance, onSuccess);
      });

      $("#update-account-save").bind("tap", function () {
        $.mobile.loading("show");
        var id = Number($("#update-account-id").val());
        var name = $("#update-account-name").val();
        var onSuccess = function () {
          $.mobile.loading("hide");
          $.mobile.changePage( "#list-accounts", { transition: "slideup"} );
        };
        updateAccount(id, name, onSuccess);
      });

      $("#update-account-delete").bind ("tap", function () {
        $.mobile.loading("show");
        var id = Number($("#update-account-id").val());
        var onSuccess = function () {
          $.mobile.loading("hide");
          $.mobile.changePage("#list-accounts", {transition: "slideup"});
        };
        deleteAccount(id, onSuccess)
      });

      $(document).bind("pagechange", function (event, data) {

        if (data.toPage.attr("id") === "list-accounts") {
          var onSuccess = function (tx, result) {
            var accounts = result.rows;
            $("#list-accounts-list").html("");
            for (var i = 0; i < accounts.length; i++) {
              $("#list-accounts-list").append("<li><a href='#update-account' data-id='" + accounts[i].rowid + "'>" + accounts[i].name + " " + accounts[i].currency + " (" + accounts[i].initialBalance + ")</a></li>");
            }
            $("#list-accounts-list").listview("refresh");
          };
          getAccounts(onSuccess);
        }

        if (data.toPage.attr("id") === "update-account") {
          var id = $(data.options.link).data("id");
          var onSuccess = function (tx, result) {
            var account = result.rows[0];
            $.mobile.loading("hide");
            $("#update-account-id").val(account.rowid);
            $("#update-account-name").val(account.name);
            $("#update-account-currency").val(account.currency);
            $("#update-account-balance").val(account.initialBalance);
          };
          getAccount(id, onSuccess);
        }
      });

      $("#transaction-type").bind("change", function(event, ui) {
          if ($(this).val() === "ingreso") {
            $("#expense-category-income").parents(".ui-field-contain").show();
            $("#expense-category-outcome").parents(".ui-field-contain").hide();
          } else {
            $("#expense-category-outcome").parents(".ui-field-contain").show();
            $("#expense-category-income").parents(".ui-field-contain").hide();
          }
      });

  });

  function loadExpensesCategories(){
    $.ajax({
      type: "GET",
      dataType: "json",
      url: "http://finanzapersonal.tribus.com.uy/categoriasGastos",
      success: onOutcomeCategoriesLoad
    });
  }

  function onOutcomeCategoriesLoad(expenses) {
    for (var i = 0; i < expenses.length ; i++) {
      $('#expense-category-outcome').append("<option value="+ i +">" + expenses[i] +"</option>");
    }
  }

  function loadIncomeCategories(){
    $.ajax({
      type: "GET",
      dataType: "json",
      url: "http://finanzapersonal.tribus.com.uy/categoriasIngresos",
      success: onIncomeCategoriesLoad
    });
  }

  function onIncomeCategoriesLoad(income){
    for(var i = 0; i < income.length ; i++){
      $('#expense-category-income').append("<option value="+ i +">" + income[i] +"</option>");
    }
  }

  /*
  * Data Base
  */

  function initializeDB (onError, onSuccess) {
    db.transaction(function (tx) {
      tx.executeSql("CREATE TABLE IF NOT EXISTS ACCOUNTS (name, currency, initialBalance)", []);
      tx.executeSql("CREATE TABLE IF NOT EXISTS ENTRIES (account, date, category, amount)", []);
    });
  }

  function addAccount (name, currency, initialBalance, onSuccess, onError) {
    db.transaction(function (tx) {
      tx.executeSql("INSERT INTO ACCOUNTS (name, currency, initialBalance) VALUES (?, ?, ?)", [name, currency, initialBalance], onSuccess, onError);
    });
  }

  function getAccounts (onSuccess, onError) {
    db.transaction(function (tx) {
      tx.executeSql("SELECT rowid, * FROM ACCOUNTS", [], onSuccess, onError);
    });
  }

  function getAccount (id, onSuccess, onError) {
    db.transaction(function (tx) {
      tx.executeSql("SELECT rowid, * FROM ACCOUNTS WHERE rowid = ? LIMIT 1", [id], onSuccess, onError);
    });
  }

  function updateAccount (id, name, onSuccess, onError) {
    db.transaction(function (tx) {
      tx.executeSql("UPDATE ACCOUNTS SET name = ? WHERE rowid = ?", [name, id], onSuccess, onError);
    });
  }

  function deleteAccount (id, onSuccess, onError) {
    db.transaction (function (tx){
      tx.executeSql ("DELETE FROM ACCOUNTS WHERE rowid = ?", [id] , onSuccess, onError);
    });
  }

  function addEntry (account, date, category, amount, onSuccess, onError) {
    db.transaction (function (tx) {
      tx.executeSql ("INSERT INTO ENTRIES (account, date, category, amount) VALUES (?, ?, ?, ?)", [account, date, category, amount], onSuccess, onError);
    });
  }

  function deleteEntry (id, onSuccess, onError){
    db.transaction (function (tx) { //modificar para que solo borre la ultima
      tx.executeSql ("DELETE FROM ENTRIES WHERE rowid = ?", [id], onSuccess, onError)
    });
  }

  /*
  * Services
  */

  function register(user, password, onSuccess) {
    $.ajax({
      url: "http://finanzapersonal.tribus.com.uy/registrar",
      type: "POST",
      dataType: "json",
      data: {
        user: user,
        password: password
      },
      success: onSuccess
    });
  }

  function login(user, password, onSuccess){
    $.ajax({
      url: "http://finanzapersonal.tribus.com.uy/login",
      type: "GET",
      dataType: "json",
      data: {
        user: user,
        password: password
      },
      success: onSuccess
    });
  }

  function addExpensesToAccount (importe, fecha, categoria, onSuccess){
    db.transaction(function(tx){
      tx.executeSql("INSERT INTO ACCOUNT (tipo, importe, fecha, categoria) values ('"+ "Gasto" + "','" + importe +"','" + fecha +"','"+ categoria +"')", [], onSuccess);
    });
  }

  function addIncomesToAccount (importe, fecha, categoria, onSuccess){
    db.transaction(function(tx){
      tx.executeSql("INSERT INTO ACCOUNT (tipo, importe, fecha, categoria) values ('"+ "Ingreso" + "','" + importe +"','" + fecha +"','"+ categoria +"')", [], onSuccess);
    });
  }




  </script>

  <div data-role="page" id="login">
    <div data-role="header">
      <h1>Login</h1>
    </div>
    <div data-role="main" class="ui-content">
      <form method="post" action="demoform.asp">
        <div class="ui-field-contain">
          <label for="userLogin">Usuario: </label>
          <input type="text" name="userLogin" id="userLogin">
        </div>
        <div class="ui-field-contain">
          <label for="passwordLogin">Contrasena: </label>
          <input type="text" name="passwordLogin" id="passwordLogin">
        </div>
        <div class="ui-field-contain">
          <p><a href="#register" data-role="link" data-inline="true">Registrarse</a></p>
        </div>
        <div class="ui-field-contain">
          <a id='login-button' data-role='button'>Entrar</a>
        </div>
      </form>
    </div>
    <div data-role="footer" data-position="fixed" data-id="footer">
      <h1>Footer Text</h1>
    </div>
  </div>

  <div data-role="page" id="register">
    <div data-role="header">
      <h1>Registro</h1>
    </div>
    <div data-role="main" class="ui-content">
      <form method="post">
        <div class="ui-field-contain">
          <label for="user">Nombre de Usuario: </label>
          <input type="text" name="user" id="userA">
        </div>
        <div class="ui-field-contain">
          <label for="password">Ingrese la contrasena: </label>
          <input type="text" name="password" id="passwordA">
        </div>
        <div class="ui-field-contain">
          <a id='register-button' data-role='button'>Entrar</a>
        </div>
      </form>
    </div>
    <div data-role="footer" data-position="fixed"  data-id="footer">
      <h1>Footer text</h1>
    </div>
  </div>

  <div data-role="page" id="add-account">
    <div data-role="header" data-add-back-btn="true">
      <h1>Menu</h1>
      <p><a href="#home" class="ui-btn-right ui-btn ui-btn-inline ui-mini ui-corner-all ui-btn-icon-right">Home</a></p>
    </div>
    <div data-role="main" class="ui-content">
      <div>
        <form>
          <div class="ui-field-contain">
            <label for="add-account-name">Nombre: </label>
            <input type="text" name="add-account-name" id="add-account-name">
          </div>
          <div class="ui-field-contain">
            <label for="add-account-currency">Moneda: </label>
            <select name="add-account-currency" id="add-account-currency" data-native-menu="false">
              <option value="usd">Dólares</option>
              <option value="uyu">Peso Uruguayo</option>
            </select>
          </div>
          <div class="ui-field-contain">
            <label for="add-account-balance">Saldo inicial:</label>
            <input type="text" name="add-account-balance" id="add-account-balance" placeholder="Ingrese el importe">
          </div>
          <div class="ui-field-contain">
            <a id="add-account-save" data-role="button"  data-theme="b">Guardar</a>
          </div>
        </div>
      </form>
    </div>
    <div data-role="footer" data-position="fixed"  data-id="footer">
      <h1>Footer Text</h1>
    </div>
  </div>

  <div data-role="page" id="update-account">
    <div data-role="header" data-add-back-btn="true">
      <h1>Menu</h1>
      <p><a href="#home" class="ui-btn-right ui-btn ui-btn-inline ui-mini ui-corner-all ui-btn-icon-right">Home</a></p>
    </div>
    <div data-role="main" class="ui-content">
      <div>
        <form method="post">
          <div class="ui-field-contain">
            <label for="update-account-id">Id: </label>
            <input type="text" name="update-account-id" id="update-account-id" readonly>
          </div>
          <div class="ui-field-contain">
            <label for="update-account-name">Nombre: </label>
            <input type="text" name="update-account-name" id="update-account-name">
          </div>
          <div class="ui-field-contain">
            <label for="update-account-currency">Moneda: </label>
            <input type="text" name="update-account-currency" id="update-account-currency" readonly>
          </div>
          <div class="ui-field-contain">
            <label for="update-account-balance">Balance: </label>
            <input type="text" name="update-account-balance" id="update-account-balance" readonly>
          </div>
          <div class="ui-field-contain">
            <a id="update-account-save" data-role="button" data-theme="b">Actualizar</a>
            <a id="update-account-delete" data-role="button" data-theme="b">Eliminar</a>
          </div>
        </div>
      </form>
    </div>
    <div data-role="footer" data-position="fixed"  data-id="footer">
      <h1>Footer Text</h1>
    </div>
  </div>

  <div data-role="page" id="list-accounts">
    <div data-role="header" data-add-back-btn="true">
      <h1>Menu</h1>
      <p><a href="#home" class="ui-btn-right ui-btn ui-btn-inline ui-mini ui-corner-all ui-btn-icon-right">Home</a></p>
    </div>
    <div data-role="main" class="ui-content">
      <ul id="list-accounts-list" data-role="listview">
        <!-- TODO: Aca van las cuentas -->
      </ul>
      <div class="ui-field-contain">
        <a href="#add-account" id="add-account-list" data-role="button" data-theme="b">Agregar Cuenta</a>
      </div>
      <div data-role="footer" data-position="fixed"  data-id="footer">
        <h1>Footer Text</h1>
      </div>
    </div>
  </div>

  <div data-role="page" id="home">
    <div data-role="header" data-add-back-btn="true">
      <h1>Menu</h1>
      <p><a href="#home" class="ui-btn-right ui-btn ui-btn-inline ui-mini ui-corner-all ui-btn-icon-right">Home</a></p>
    </div>
    <div data-role="main" class="ui-content">
      <div data-role="controlgroup" data-type="vertical">
        <a href="#list-accounts" data-role="button">Cuentas</a>
        <a href="#entries" data-role="button">Movimientos</a>
        <a href="#account" data-role="button">Estado de cuenta</a>
      </div>
    </div>
    <div data-role="footer" data-position="fixed" data-id="footer">
      <h1>Footer Text</h1>
    </div>
  </div>

  <div data-role="page" id="entries">
    <div data-role="header" data-add-back-btn="true">
      <h1>Movimientos</h1>
      <p><a href="#menu" class="ui-btn-right ui-btn ui-btn-inline ui-mini ui-corner-all ui-btn-icon-right">Menu</a></p>
    </div>
    <div data-role="main" class="ui-content">
      <div>
        <form method="post" action="demoform.asp">
          <div class="ui-field-contain">
            <label for="transaction-type">Transacción: </label>
            <select name="transaction-type" id="transaction-type" data-native-menu="false">
              <option value="gasto" selected>Gasto</option>
              <option value="ingreso">Ingreso</option>
            </select>
          </div>
          <div class="ui-field-contain">
            <label for="expense-date">Fecha: </label>
            <input type="date" name="expense-date" id="expense-date">
          </div>
          <div class="ui-field-contain">
            <label for="expense-amount">Importe: </label>
            <input type="text" name="expense-amount" id="expense-amount">
          </div>

          <div class="ui-field-contain">
            <label for="expense-category-outcome">Categoria: </label>
            <select name="expense-category-outcome" id="expense-category-outcome" data-native-menu="false"></select>
          </div>
          <div class="ui-field-contain" style="display: none;">
            <label for="expense-category-income">Categoria: </label>
            <select name="expense-category-income" id="expense-category-income" data-native-menu="false"></select>
          </div>
          <div class="ui-field-contain">
              <a id='expense-save-button' data-role='button'>Entrar</a>
          </div>
        </div>
      </form>
    </div>
    <div data-role="footer" data-position="fixed"  data-id="footer">
      <h1>Footer Text</h1>
    </div>
  </div>


  <div data-role="page" id="transfer">
    <div data-role="header" data-add-back-btn="true">
      <h1>Ingresos</h1>
      <p><a href="#menu" class="ui-btn-right ui-btn ui-btn-inline ui-mini ui-corner-all ui-btn-icon-right">Menu</a></p>
    </div>
    <div data-role="main" class="ui-content">
      <div>
        <form method="post" action="demoform.asp">
          <div class="ui-field-contain">
            <label for="incomeDate">Fecha: </label>
            <input type="date" name="incomeDate" id="incomeDate">
          </div>
          <div class="ui-field-contain">
            <label for="incomeAmount">Importe: </label>
            <input type="text" name="incomeAmount" id="incomeAmount">
          </div>
          <div class="ui-field-contain">
            <label for="clientLabel">Categoria: </label>
            <select name="clientDdl" id="clientDdl" data-native-menu="false"></select>

          </div>
          <div class="ui-field-contain">
            <a href="#AddClient" class="ui-btn ui-shadow ui-corner-all ui-icon-plus ui-btn-icon-notext" data-inline="true" data-mini="true"></a>
          </div>
          <div class="ui-field-contain">
            <label for="noteExpenses">Nota: </label>
            <textarea name="noteExpenses" id="noteExpenses"></textarea>
          </div>
          <div class="ui-field-contain">
            <a href="#menu" data-role="button"  data-theme="b">Guardar</a>
          </div>
        </div>
      </form>
    </div>
    <div data-role="footer" data-position="fixed"  data-id="footer">
      <h1>Footer Text</h1>
    </div>
  </div>

  <div data-role="page" id="account">
    <div data-role="header" data-add-back-btn="true">
      <h1>Estado de cuenta</h1>
      <p><a href="#menu" class="ui-btn-right ui-btn ui-btn-inline ui-mini ui-corner-all ui-btn-icon-right">Menu</a></p>
    </div>
    <div data-role="main" class="ui-content">
      <div>
        <form method="post" action="demoform.asp">
          <div class="ui-grid-b">
            <div class="ui-block-a">Block A</div>
            <div class="ui-block-b">Block B</div>
            <div class="ui-block-c">Block C</div>
          </div>
          <div class="ui-field-contain">
            <a href="#menu" data-role="button"  data-theme="b">Guardar</a>
          </div>
        </form>
      </div>
    </div>
    <div data-role="footer" data-position="fixed"  data-id="footer">
      <h1>Footer Text</h1>
    </div>
  </div>

</body>
</html>
